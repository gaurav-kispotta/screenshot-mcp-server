<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screenshot MCP Server Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    h1 {
      color: #0066cc;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .sidebar {
      flex: 1;
      min-width: 300px;
      background-color: #f5f5f7;
      padding: 15px;
      border-radius: 8px;
      max-height: 800px;
      overflow-y: auto;
    }
    .content {
      flex: 2;
      min-width: 400px;
      display: flex;
      flex-direction: column;
    }
    .window-item {
      padding: 10px;
      margin-bottom: 5px;
      background-color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .window-item:hover {
      background-color: #e1f0ff;
    }
    .window-item.active {
      background-color: #0066cc;
      color: white;
    }
    .controls {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f5f5f7;
      border-radius: 8px;
    }
    .controls button {
      padding: 8px 16px;
      margin-right: 10px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .controls button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .screenshot-area {
      background-color: #f5f5f7;
      padding: 15px;
      border-radius: 8px;
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .screenshot-img {
      max-width: 100%;
      max-height: 600px;
      object-fit: contain;
    }
    .events {
      margin-top: 20px;
      background-color: #f5f5f7;
      padding: 15px;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
    }
    .event-item {
      padding: 5px;
      margin-bottom: 5px;
      border-radius: 4px;
      background-color: white;
      font-size: 0.9rem;
    }
    .loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #0066cc;
      visibility: hidden;
    }
    .showing-loading .loading {
      visibility: visible;
    }
    select, input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Screenshot MCP Server Demo</h1>
    <p>Control and capture screenshots of macOS windows through the Media Control Protocol</p>
  </header>

  <div class="container">
    <div class="sidebar">
      <h2>Windows</h2>
      <div>
        <button id="refresh-windows-btn">Refresh List</button>
        <button id="active-window-btn">Go to Active Window</button>
      </div>
      <div id="window-list"></div>
    </div>
    
    <div class="content">
      <div class="controls">
        <h2>Screenshot Controls</h2>
        <div>
          <select id="format-select">
            <option value="png">PNG</option>
            <option value="jpg">JPEG</option>
            <option value="webp">WebP</option>
            <option value="tiff">TIFF</option>
          </select>
          <input type="number" id="quality-input" min="1" max="100" value="80" placeholder="Quality (1-100)">
          <button id="capture-window-btn" disabled>Capture Selected Window</button>
          <button id="capture-screen-btn">Capture Full Screen</button>
        </div>
      </div>
      
      <div class="screenshot-area" id="screenshot-container">
        <img id="screenshot-img" class="screenshot-img" alt="No screenshot yet" style="display: none;">
        <div class="loading">Capturing screenshot...</div>
        <p id="no-screenshot-message">No screenshot captured yet. Select a window and click "Capture".</p>
      </div>
      
      <div class="events">
        <h2>Window Events</h2>
        <div id="events-list"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to the WebSocket server
    const socket = io();
    
    // DOM elements
    const windowListEl = document.getElementById('window-list');
    const refreshWindowsBtn = document.getElementById('refresh-windows-btn');
    const activeWindowBtn = document.getElementById('active-window-btn');
    const captureWindowBtn = document.getElementById('capture-window-btn');
    const captureScreenBtn = document.getElementById('capture-screen-btn');
    const formatSelect = document.getElementById('format-select');
    const qualityInput = document.getElementById('quality-input');
    const screenshotImg = document.getElementById('screenshot-img');
    const noScreenshotMessage = document.getElementById('no-screenshot-message');
    const screenshotContainer = document.getElementById('screenshot-container');
    const eventsList = document.getElementById('events-list');
    
    // State
    let selectedWindow = null;
    let windows = [];
    
    // Update window list
    function refreshWindows() {
      socket.emit('windows:list', {}, (response) => {
        if (response.success) {
          windows = response.windows;
          renderWindowList();
        } else {
          console.error('Failed to get windows:', response.error);
        }
      });
    }
    
    // Find active window
    function goToActiveWindow() {
      socket.emit('windows:active', {}, (response) => {
        if (response.success && response.window) {
          selectedWindow = response.window;
          renderWindowList();
          scrollToSelectedWindow();
        } else {
          console.error('Failed to get active window:', response.error);
        }
      });
    }
    
    // Render window list
    function renderWindowList() {
      windowListEl.innerHTML = '';
      
      windows.forEach(window => {
        const windowEl = document.createElement('div');
        windowEl.className = 'window-item';
        if (selectedWindow && selectedWindow.id === window.id) {
          windowEl.classList.add('active');
        }
        
        windowEl.innerHTML = `
          <strong>${window.title || 'Untitled'}</strong><br>
          <small>${window.appName} (${window.bounds.width}Ã—${window.bounds.height})</small>
        `;
        
        windowEl.addEventListener('click', () => {
          selectedWindow = window;
          captureWindowBtn.disabled = false;
          renderWindowList();
        });
        
        windowListEl.appendChild(windowEl);
      });
    }
    
    // Scroll to selected window
    function scrollToSelectedWindow() {
      const activeEl = windowListEl.querySelector('.window-item.active');
      if (activeEl) {
        activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    // Capture screenshot
    function captureScreenshot(target, windowId = null) {
      screenshotContainer.classList.add('showing-loading');
      noScreenshotMessage.style.display = 'none';
      
      const options = {
        format: formatSelect.value,
        quality: parseInt(qualityInput.value, 10)
      };
      
      const request = {
        target,
        options
      };
      
      if (windowId) {
        request.windowId = windowId;
      }
      
      socket.emit('screenshot:capture', request, (response) => {
        screenshotContainer.classList.remove('showing-loading');
        
        if (response.success) {
          screenshotImg.src = `data:image/${response.metadata.format};base64,${response.image}`;
          screenshotImg.style.display = 'block';
        } else {
          console.error('Screenshot capture failed:', response.error);
          alert('Screenshot capture failed: ' + response.error);
        }
      });
    }
    
    // Add window event
    function addEvent(event) {
      const eventEl = document.createElement('div');
      eventEl.className = 'event-item';
      
      const time = new Date(event.timestamp).toLocaleTimeString();
      eventEl.textContent = `[${time}] ${event.type}: ${event.window.title} (${event.window.appName})`;
      
      eventsList.prepend(eventEl);
      
      // Keep only last 20 events
      const events = eventsList.querySelectorAll('.event-item');
      if (events.length > 20) {
        eventsList.removeChild(events[events.length - 1]);
      }
    }
    
    // Setup event handlers
    refreshWindowsBtn.addEventListener('click', refreshWindows);
    activeWindowBtn.addEventListener('click', goToActiveWindow);
    
    captureWindowBtn.addEventListener('click', () => {
      if (selectedWindow) {
        captureScreenshot('window', selectedWindow.id);
      }
    });
    
    captureScreenBtn.addEventListener('click', () => {
      captureScreenshot('screen');
    });
    
    // Socket event handlers
    socket.on('connect', () => {
      console.log('Connected to server');
      refreshWindows();
      goToActiveWindow();
      
      // Subscribe to window events
      socket.emit('subscribe:window_events');
    });
    
    socket.on('window_event', (event) => {
      addEvent(event);
      
      // Refresh window list when windows change
      if (['created', 'closed'].includes(event.type)) {
        refreshWindows();
      }
    });
    
    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
    });
  </script>
</body>
</html>
